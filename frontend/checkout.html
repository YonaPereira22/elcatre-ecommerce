
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Checkout — El Catre S.R.L</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--azul:#17468f;--b:#111;--borde:#e5eaf1;--bg:#f6f8fb}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#f7f9ff 0%,#fff 100%)}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}

    header{background:var(--azul);color:#fff}
    header .wrap{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
    header img{height:32px;border-radius:6px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin:18px 0}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--borde);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--borde)}
    .card .body{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--borde);border-radius:8px;background:#fff}
    textarea{min-height:88px;resize:vertical}
    .chk{display:flex;gap:8px;align-items:center;margin-top:8px}
    .btn{display:inline-block;background:var(--azul);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .muted{color:#666}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .total{font-size:18px;font-weight:800}
    .empty{padding:10px;background:#fff5f5;border:1px solid #ffdede;border-radius:8px}
    .ok{padding:10px;background:#f0fff3;border:1px solid #beefc3;border-radius:8px;margin-bottom:12px}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;gap:12px;border-bottom:1px dashed #eaeff6;padding-bottom:8px}
    .item:last-child{border-bottom:0}

    /* NUEVO: métodos de entrega */
    .radio-list{display:grid;gap:8px;margin:10px 0}
    .radio-item{display:flex;gap:10px;align-items:flex-start;background:#f8fafc;border:1px solid var(--borde);border-radius:10px;padding:10px}
    .radio-item strong{display:block}
    .fieldset{display:grid;gap:8px;margin:14px 0}
    .fieldset.inline{grid-template-columns:1fr 1fr}
    @media (max-width: 700px){ .fieldset.inline{grid-template-columns:1fr} }
    .hidden{display:none !important}
  
    #metodos-pago {
  background: #f4f7fb;
  border: 1px solid var(--borde);
  border-radius: 12px;
  padding: 14px;
  margin-top: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.05);
}

  #metodos-pago p {
    font-weight: 600;
    color: var(--azul);
    margin-bottom: 10px;
  }

  #metodos-pago .btn {
    margin: 5px;
    background: var(--azul);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background .2s;
  }

  #metodos-pago .btn:hover {
    background: #103469;
  }

  .modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  width: 320px;
  box-shadow: 0 4px 15px rgba(0,0,0,.3);
}
.modal-content h2 {
  text-align: center;
  color: #17468f;
  margin-bottom: 15px;
}
.modal-content input {
  width: 100%;
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.modal-content .acciones {
  display: flex;
  justify-content: space-between;
}
.btn-secondary {
  background: #ccc;
  color: #333;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
}


  </style>
</head>
<body>

<header>
  <div class="container wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="img/logo-el-catre.jpg" alt="El Catre">
      <strong>El Catre — Mueblería</strong>
    </div>
    <nav>
      <a href="index.html" style="color:#fff;margin-right:10px">Inicio</a>
      <a href="carrito.html" style="color:#fff">Carrito</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid">

    <!-- FORMULARIO -->
    <section class="card">
      <h2>Datos para la entrega</h2>
      <div class="body">
        <div id="msg" class="ok" style="display:none"></div>

        <!-- Contacto -->
        <div class="row">
          <div>
            <label>Nombre y apellido</label>
            <input id="nombre" placeholder="Ej: Juan Pérez" required>
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="tu@correo.com" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Celular</label>
            <input id="telefono" placeholder="Ej: 09x xxx xxx">
          </div>
          <div>
            <label>Departamento</label>
            <select id="departamento">
              <option value="">Seleccionar…</option>
              <option>Montevideo</option><option>Canelones</option><option>Maldonado</option>
              <option>Lavalleja</option><option>Rocha</option><option>Tacuarembó</option>
              <option>Treinta y Tres</option><option>Florida</option><option>Durazno</option>
              <option>Colonia</option><option>Flores</option><option>San José</option>
              <option>Artigas</option><option>Salto</option><option>Paysandú</option>
              <option>Rivera</option><option>Rio Negro</option><option>Soriano</option>
              <option>Cerro Largo</option>
            </select>
          </div>
        </div>

        <!-- Dirección base (se usa en SC y en interior si querés) -->
        <div class="row">
          <div>
            <label>Ciudad/Localidad</label>
            <input id="ciudad" placeholder="Ej: Santa Clara de Olimar">
          </div>
          <div>
            <label>Dirección</label>
            <input id="direccion" placeholder="Calle, número, apto/casa">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Referencias de acceso</label>
            <textarea id="referencias" placeholder="Piso/ascensor, ancho de puertas, referencias…"></textarea>
          </div>
          <div>
            <label>Agenda preferida</label>
            <input id="agenda" type="date">
            <div class="muted">Coordinamos por email/WhatsApp la franja horaria</div>
            <!-- quitamos “retira_local” checkbox: ahora es un método -->
            <label class="chk"><input type="checkbox" id="factura_empresa"> Factura para empresa (RUT)</label>
            <input id="rut" placeholder="RUT (si corresponde)" style="margin-top:6px;display:none">
          </div>
        </div>

        <hr>

        <!-- MÉTODO DE ENTREGA (NUEVO) -->
        <h3 style="margin:0 0 8px">Método de entrega</h3>
        <div class="radio-list" id="metodos">
          <!-- 1) Armado SC -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="armado_sc" required>
            <div>
              <strong>Armado en domicilio — Santa Clara</strong>
              <span class="muted">Armado por personal en Santa Clara. Requiere dirección.</span>
            </div>
          </label>
          <!-- 4) Envío gratis SC -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="envio_gratis_sc" required>
            <div>
              <strong>Envío <u>gratis</u> — Santa Clara</strong>
              <span class="muted">Franja horaria: 08–12 o 14–18. Requiere dirección.</span>
            </div>
          </label>
          <!-- 2) Retiro local -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="retiro_local" required>
            <div>
              <strong>Retiro en local</strong>
              <span class="muted">Coordiná día y horario de retiro.</span>
            </div>
          </label>
          <!-- 3) Interior -->
          <label class="radio-item">
            <input type="radio" name="metodo" value="envio_interior" required>
            <div>
              <strong>Envío Interior (DAC, Mirtrans, Nuñez)</strong>
              <span class="muted">Despacho por empresa. Requiere datos del receptor y ciudad.</span>
            </div>
          </label>
        </div>

        <!-- GRUPOS CONDICIONALES -->
        <!-- Para SC (armado/envío gratis) -->
        <div id="grp-direccion-sc" class="fieldset hidden">
          <label for="direccion_sc">Dirección (Santa Clara de Olimar)</label>
          <input type="text" id="direccion_sc" placeholder="Calle, número, esquina, referencias">
        </div>

        <!-- Franja para “envío gratis SC” -->
        <div id="grp-franja" class="fieldset inline hidden">
          <div>
            <label for="franja">Franja horaria</label>
            <select id="franja">
              <option value="">Elegí…</option>
              <option value="08-12">08:00 a 12:00</option>
              <option value="14-18">14:00 a 18:00</option>
            </select>
          </div>
        </div>

        <!-- Retiro en local -->
        <div id="grp-retiro" class="fieldset inline hidden">
          <div>
            <label for="retiro_fecha">Día de retiro</label>
            <input type="date" id="retiro_fecha">
          </div>
          <div>
            <label for="retiro_hora">Horario</label>
            <input type="time" id="retiro_hora">
          </div>
        </div>

        <!-- Envío interior -->
        <div id="grp-interior" class="fieldset hidden">
          <div class="row">
            <div>
              <label for="empresa">Empresa</label>
              <select id="empresa">
                <option value="">Elegí empresa</option>
                <option>DAC</option>
                <option>Mirtrans</option>
                <option>Nuñez</option>
                <option>Correo Uruguayo</option>

              </select>
            </div>
            <div>
              <label for="recibe">Nombre de quien recibe</label>
              <input id="recibe" placeholder="Nombre y apellido">
            </div>
          </div>
          <div>
            <label for="ciudad_int">Ciudad (interior)</label>
            <input id="ciudad_int" placeholder="Ciudad/Dpto.">
          </div>
        </div>

        <label style="display:inline-flex;align-items:center;gap:8px;white-space:nowrap;font-weight:600">
        <label style="display:inline-flex;align-items:center;gap:8px;white-space:nowrap;font-weight:600">
            <input type="checkbox" id="acepto">
            <span>Acepto las <a href="politicas.html" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">políticas</a></span>
          </label>


        <div style="margin-top:16px">
          <button class="btn" id="btn-pagar">Confirmar pedido</button>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <aside class="card">
      <h2>Resumen del carrito</h2>
      <div class="body">
        <div id="resumen"></div>
        <div id="metodos-pago" style="margin-top:20px; text-align:center; display:none;"></div>
      </div>
    </aside>
  
   <!-- 🧾 Modal de pago con tarjeta -->
  <div id="modal-tarjeta" class="modal">
    <div class="modal-content">
      <h2>Pago con tarjeta</h2>
      <form id="form-tarjeta">
        <label>Nombre del titular</label>
        <input type="text" id="nombre-tarjeta" required placeholder="Ej: Juan Pérez">

        <label>Número de tarjeta</label>
        <input type="text" id="numero-tarjeta" maxlength="19" placeholder="#### #### #### ####" required>

        <label>Vencimiento</label>
        <input type="text" id="vencimiento-tarjeta" maxlength="5" placeholder="MM/AA" required>

        <label>CVV</label>
        <input type="password" id="cvv-tarjeta" maxlength="3" placeholder="***" required>

        <div class="acciones">
          <button type="submit" class="btn">💳 Confirmar pago</button>
          <button type="button" id="cerrar-modal" class="btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  </div>
</main>

<script>
  const API = 'http://localhost/Muebleria/backend/api.php';

  // Mostrar RUT si tildan "Factura empresa"
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id==='factura_empresa'){
      document.getElementById('rut').style.display = e.target.checked ? 'block' : 'none';
    }
  });

  // Cargar resumen desde localStorage (el que usa data.js)
  function cargarResumen(){
    const carrito = JSON.parse(localStorage.getItem('carrito'))||[];
    const total   = parseFloat(localStorage.getItem('total'))||0;
    const div = document.getElementById('resumen');

    if(!carrito.length){
      div.innerHTML = `<div class="empty">Tu carrito está vacío. <a href="index.html">Ir al catálogo</a></div>`;
      document.getElementById('btn-pagar').disabled = true;
      return;
    }
    
    const items = carrito.map(it => `
      <div class="item">
        <span>${it.nombre}</span>
        <strong>UYU ${it.precio.toLocaleString('es-UY')}</strong>
      </div>
    `).join('');

    div.innerHTML = `
      <div class="list">${items}</div>
      <hr>
      <div class="line"><span>Envío</span><span class="muted">Se coordina</span></div>
      <div class="line total"><span>Total</span><span>UYU ${total.toLocaleString('es-UY')}</span></div>
    `;
  }
  cargarResumen();

  // Prefill básico si hay sesión (opcional)
  (async function prefill(){
    try{
      const r = await fetch(API + '?action=pedido_crear', {
        method:'POST',
        body,
        credentials:'include'
      });

      const j = await r.json();
      if(j.authenticated){
        document.getElementById('nombre').value = j.user.nombre || '';
        document.getElementById('email').value  = j.user.email  || '';
      }
    }catch(_){}
  })();

  // ---------- NUEVO: condicionales de método de entrega ----------
  (function initMetodo(){
    const radios = document.querySelectorAll('input[name="metodo"]');
    const grpDirSC   = document.getElementById('grp-direccion-sc');
    const dirSC      = document.getElementById('direccion_sc');
    const grpFranja  = document.getElementById('grp-franja');
    const franja     = document.getElementById('franja');
    const grpRetiro  = document.getElementById('grp-retiro');
    const rFecha     = document.getElementById('retiro_fecha');
    const rHora      = document.getElementById('retiro_hora');
    const grpInt     = document.getElementById('grp-interior');
    const empresa    = document.getElementById('empresa');
    const recibe     = document.getElementById('recibe');
    const ciudadInt  = document.getElementById('ciudad_int');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function setReq(el, v){ if(el) el.required = !!v; }

    function apply(value){
      [grpDirSC, grpFranja, grpRetiro, grpInt].forEach(hide);
      [dirSC, franja, rFecha, rHora, empresa, recibe, ciudadInt].forEach(el=> setReq(el,false));

      if(value==='armado_sc'){ show(grpDirSC); setReq(dirSC,true); }
      if(value==='envio_gratis_sc'){ show(grpDirSC); show(grpFranja); setReq(dirSC,true); setReq(franja,true); }
      if(value==='retiro_local'){ show(grpRetiro); setReq(rFecha,true); setReq(rHora,true); const today = new Date(); today.setHours(0,0,0,0); rFecha.min = today.toISOString().slice(0,10); }
      if(value==='envio_interior'){ show(grpInt); setReq(empresa,true); setReq(recibe,true); setReq(ciudadInt,true); }
    }
    radios.forEach(r=>{ r.addEventListener('change', ()=> apply(r.value)); if(r.checked) apply(r.value); });
  })();

  // ✅ Envío del pedido y despliegue de opciones de pago
  document.getElementById('btn-pagar').onclick = async ()=>{
    const nombre = document.getElementById('nombre').value.trim();
    const email  = document.getElementById('email').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const departamento = document.getElementById('departamento').value.trim();
    const ciudad = document.getElementById('ciudad').value.trim();
    const direccion = document.getElementById('direccion').value.trim();
    const referencias = document.getElementById('referencias').value.trim();
    const agenda = document.getElementById('agenda').value;
    const facturaEmpresa = document.getElementById('factura_empresa').checked;
    const rut = document.getElementById('rut').value.trim();
    const acepto = document.getElementById('acepto').checked;

    const metodo = (document.querySelector('input[name="metodo"]:checked')||{}).value;
    const dirSC  = document.getElementById('direccion_sc')?.value.trim() || '';
    const franja = document.getElementById('franja')?.value || '';
    const rFecha = document.getElementById('retiro_fecha')?.value || '';
    const rHora  = document.getElementById('retiro_hora')?.value || '';
    const empresa= document.getElementById('empresa')?.value || '';
    const recibe = document.getElementById('recibe')?.value.trim() || '';
    const ciudadInt = document.getElementById('ciudad_int')?.value.trim() || '';

    const msg = document.getElementById('msg'); msg.style.display='none'; msg.textContent='';

    if(!acepto){ alert('Debés aceptar las políticas'); return; }
    if(!nombre || !email){ alert('Completá nombre y email'); return; }
    if(!metodo){ alert('Elegí un método de entrega'); return; }

    // Validaciones mínimas según método
    if(metodo==='armado_sc' && !dirSC){ alert('Ingresá la dirección para armado en Santa Clara.'); return; }
    if(metodo==='envio_gratis_sc' && (!dirSC || !franja)){ alert('Ingresá la dirección y franja horaria.'); return; }
    if(metodo==='retiro_local' && (!rFecha || !rHora)){ alert('Elegí día y hora de retiro.'); return; }
    if(metodo==='envio_interior' && (!empresa || !recibe || !ciudadInt)){ alert('Completá empresa, receptor y ciudad.'); return; }

    let metodoStr = ''; let extra = '';
    if(metodo==='armado_sc'){ metodoStr = 'Armado en domicilio — Santa Clara'; extra = `Dir SC: ${dirSC}`; }
    if(metodo==='envio_gratis_sc'){ metodoStr = 'Envío gratis — Santa Clara'; extra = `Dir SC: ${dirSC} — Franja: ${franja}`; }
    if(metodo==='retiro_local'){ metodoStr = 'Retiro en local'; extra = `Retiro: ${rFecha} ${rHora}`; }
    if(metodo==='envio_interior'){ metodoStr = 'Envío interior'; extra = `Empresa: ${empresa} — Recibe: ${recibe} — Ciudad: ${ciudadInt}`; }

    const direccionExtendida =
      `${direccion} — ${ciudad}, ${departamento}` +
      (referencias?` — Ref: ${referencias}`:'') +
      (agenda?` — Agenda pref.: ${agenda}`:'') +
      ` — [${metodoStr}] ${extra}`;

    const body = new URLSearchParams({
      action:'pedido_crear',
      nombre, email,
      telefono,
      direccion: direccionExtendida
    });

    try{
      // 🔧 SINCRONIZAR carrito local → backend antes de crear pedido
      const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      await fetch(API+'?action=carrito_sync', {
        method:'POST',
        credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(carrito)
      });

      // 🔧 Enviar pedido con sesión
      console.log('➡️ Enviando pedido_crear a:', API);
      console.log('🧾 Body:', body.toString());

      const r = await fetch(API, {
        method:'POST',
        body,
        credentials:'include'
      });

      console.log('⬅️ Response status:', r.status);
      const text = await r.text();
      console.log('📦 Response raw:', text);

      let j;
      try { j = JSON.parse(text); }
      catch { throw new Error('Respuesta no JSON: ' + text); }

      if(!r.ok){ alert(j.error || 'No pudimos confirmar el pedido'); return; }

      // 🧾 Mostrar mensaje y opciones de pago ficticias
      msg.innerHTML = `<p>¡Gracias! Pedido #${j.pedido_id} confirmado.</p>`;
      msg.style.display = 'block';

      // Mostrar botones en el panel derecho
      const pagos = document.getElementById('metodos-pago');
      pagos.innerHTML = `
        <p>Seleccioná tu método de pago:</p>
        <button class="btn" onclick="pagoTarjeta()">💳 Tarjeta</button>
        <button class="btn" onclick="pagoMP()">🔗 Mercado Pago</button>
        <button class="btn" onclick="pagoTransferencia()">🏦 Transferencia</button>
      `;
      pagos.style.display = 'block';

    }catch(e){
      alert('Error de red');
    }
  }; // 👈 cierro correctamente la función btn-pagar


  // 💳 Pasarelas ficticias — ahora fuera del onclick ✅
  function pagoTarjeta(){
  const modal = document.getElementById('modal-tarjeta');
  modal.style.display = 'flex';

  // Cerrar modal
  document.getElementById('cerrar-modal').onclick = () => {
    modal.style.display = 'none';
  };

  // Enviar formulario
  const form = document.getElementById('form-tarjeta');
  form.onsubmit = (e)=>{
    e.preventDefault();
    modal.style.display = 'none';
    alert('✅ Pago procesado con éxito.\n¡Gracias por tu compra!');
    localStorage.clear();
    location.href='index.html';
  };
}

  function pagoMP(){
    alert('🔗 Redirigiendo a Mercado Pago...');
    window.open('https://www.mercadopago.com.uy', '_blank');
  }

  function pagoTransferencia(){
    alert('🏦 Transferencia a cuenta BROU 001-2345678.\nEnviá el comprobante por WhatsApp.');
    localStorage.removeItem('carrito');
    localStorage.setItem('total','0');
    location.href='index.html';
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", async function() {
  const authBox = document.getElementById('auth-box');
  if (!authBox) return;

  // --- Recuperar del almacenamiento local
  let user = null;
  try {
    user = JSON.parse(localStorage.getItem('usuarioActual')) || null;
  } catch(e) {
    user = null;
  }

  // --- Verificar sesión con el backend
  try {
    const res = await fetch('http://localhost/Muebleria/backend/api.php?action=auth_me', {
      credentials: 'include'
    });
    const data = await res.json();
    if (data.authenticated && data.user) {
      user = data.user;
      localStorage.setItem('usuarioActual', JSON.stringify(user));
    }
  } catch(err) {
    console.warn('No se pudo verificar la sesión con el backend', err);
  }

  // --- Mostrar según el estado
  if (user) {
    authBox.innerHTML = `
      <span>👋 Hola, <strong>${user.nombre || user.email}</strong></span>
      <button class="btn white" onclick="logout()">Cerrar sesión</button>
    `;
  } else {
    authBox.innerHTML = `
      <a class="btn" href="login.html">Login</a>
      <a class="btn white" href="register.html">Registrarse</a>
    `;
  }

  // --- Cierre de sesión global
  window.logout = async function() {
    localStorage.removeItem('usuarioActual');
    try {
      await fetch('http://localhost/Muebleria/backend/api.php?action=auth_logout', {
        method: 'POST',
        credentials: 'include'
      });
    } catch(e) {}
    location.href = 'login.html';
  };
});
</script>

</body>
</html>

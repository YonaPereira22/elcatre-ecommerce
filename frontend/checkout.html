<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Checkout — El Catre S.R.L</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--azul:#17468f;--b:#111;--borde:#e5eaf1;--bg:#f6f8fb}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#f7f9ff 0%,#fff 100%)}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}

    header{background:var(--azul);color:#fff}
    header .wrap{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
    header img{height:32px;border-radius:6px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin:18px 0}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--borde);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--borde)}
    .card .body{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--borde);border-radius:8px;background:#fff}
    textarea{min-height:88px;resize:vertical}
    .chk{display:flex;gap:8px;align-items:center;margin-top:8px}
    .btn{display:inline-block;background:var(--azul);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .muted{color:#666}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .total{font-size:18px;font-weight:800}
    .empty{padding:10px;background:#fff5f5;border:1px solid #ffdede;border-radius:8px}
    .ok{padding:10px;background:#f0fff3;border:1px solid #beefc3;border-radius:8px;margin-bottom:12px}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;gap:12px;border-bottom:1px dashed #eaeff6;padding-bottom:8px}
    .item:last-child{border-bottom:0}
  </style>
</head>
<body>

<header>
  <div class="container wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="img/logo-el-catre.jpg" alt="El Catre">
      <strong>El Catre — Mueblería</strong>
    </div>
    <nav>
      <a href="index.html" style="color:#fff;margin-right:10px">Inicio</a>
      <a href="carrito.html" style="color:#fff">Carrito</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid">

    <!-- FORMULARIO -->
    <section class="card">
      <h2>Datos para la entrega</h2>
      <div class="body">
        <div id="msg" class="ok" style="display:none"></div>

        <div class="row">
          <div>
            <label>Nombre y apellido</label>
            <input id="nombre" placeholder="Ej: Juan Pérez">
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="tu@correo.com">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Celular</label>
            <input id="telefono" placeholder="Ej: 09x xxx xxx">
          </div>
          <div>
            <label>Departamento</label>
            <select id="departamento">
              <option value="">Seleccionar…</option>
              <option>Montevideo</option><option>Canelones</option><option>Maldonado</option>
              <option>Lavalleja</option><option>Rocha</option><option>Tacuarembó</option>
              <option>Treinta y Tres</option><option>Florida</option><option>Durazno</option>
              <option>Colonia</option><option>Flores</option><option>San José</option>
              <option>Artigas</option><option>Salto</option><option>Paysandú</option>
              <option>Rivera</option><option>Rio Negro</option><option>Soriano</option>
              <option>Cerro Largo</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ciudad/Localidad</label>
            <input id="ciudad" placeholder="Ej: Santa Clara de Olimar">
          </div>
          <div>
            <label>Dirección</label>
            <input id="direccion" placeholder="Calle, número, apto/casa">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Referencias de acceso</label>
            <textarea id="referencias" placeholder="Piso/ascensor, ancho de puertas, referencias…"></textarea>
          </div>
          <div>
            <label>Agenda preferida</label>
            <input id="agenda" type="date">
            <div class="muted">Coordinamos por email/WhatsApp la franja horaria</div>
            <label class="chk"><input type="checkbox" id="retira_local"> Retiro en local/depo</label>
            <label class="chk"><input type="checkbox" id="factura_empresa"> Factura para empresa (RUT)</label>
            <input id="rut" placeholder="RUT (si corresponde)" style="margin-top:6px;display:none">
          </div>
        </div>

        <label class="chk" style="margin-top:10px">
          <input type="checkbox" id="acepto"> Acepto las <a href="politicas.html" target="_blank" style="margin-left:6px;color:#17468f">políticas</a>
        </label>

        <div style="margin-top:16px">
          <button class="btn" id="btn-pagar">Confirmar pedido</button>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <aside class="card">
      <h2>Resumen del carrito</h2>
      <div class="body">
        <div id="resumen"></div>
      </div>
    </aside>

  </div>
</main>

<script>
  const API = '../backend/api.php';

  // Mostrar RUT si tildan "Factura empresa"
  document.addEventListener('change', (e)=>{
    if(e.target && e.target.id==='factura_empresa'){
      document.getElementById('rut').style.display = e.target.checked ? 'block' : 'none';
    }
  });

  // Cargar resumen desde localStorage (el que usa data.js)
  function cargarResumen(){
    const carrito = JSON.parse(localStorage.getItem('carrito'))||[];
    const total   = parseFloat(localStorage.getItem('total'))||0;
    const div = document.getElementById('resumen');

    if(!carrito.length){
      div.innerHTML = `<div class="empty">Tu carrito está vacío. <a href="index.html">Ir al catálogo</a></div>`;
      document.getElementById('btn-pagar').disabled = true;
      return;
    }

    const items = carrito.map(it => `
      <div class="item">
        <span>${it.nombre}</span>
        <strong>UYU ${it.precio.toLocaleString('es-UY')}</strong>
      </div>
    `).join('');

    div.innerHTML = `
      <div class="list">${items}</div>
      <hr>
      <div class="line"><span>Envío</span><span class="muted">Se coordina</span></div>
      <div class="line total"><span>Total</span><span>UYU ${total.toLocaleString('es-UY')}</span></div>
    `;
  }
  cargarResumen();

  // Prefill básico si hay sesión (opcional)
  (async function prefill(){
    try{
      const r = await fetch(API+'?action=auth_me',{credentials:'include'});
      const j = await r.json();
      if(j.authenticated){
        document.getElementById('nombre').value = j.user.nombre || '';
        document.getElementById('email').value  = j.user.email  || '';
      }
    }catch(_){}
  })();

  // Enviar pedido al backend
  document.getElementById('btn-pagar').onclick = async ()=>{
    const nombre = document.getElementById('nombre').value.trim();
    const email  = document.getElementById('email').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const departamento = document.getElementById('departamento').value.trim();
    const ciudad = document.getElementById('ciudad').value.trim();
    const direccion = document.getElementById('direccion').value.trim();
    const referencias = document.getElementById('referencias').value.trim();
    const agenda = document.getElementById('agenda').value;
    const retira = document.getElementById('retira_local').checked;
    const facturaEmpresa = document.getElementById('factura_empresa').checked;
    const rut = document.getElementById('rut').value.trim();
    const acepto = document.getElementById('acepto').checked;

    const msg = document.getElementById('msg'); msg.style.display='none'; msg.textContent='';

    if(!acepto){ alert('Debés aceptar las políticas'); return; }
    if(!nombre || !email){ alert('Completá nombre y email'); return; }

    // Compacto datos “extra” dentro de la dirección (sin tocar tu schema)
    const direccionExtendida =
      `${direccion} — ${ciudad}, ${departamento}` +
      (referencias?` — Ref: ${referencias}`:'') +
      (agenda?` — Agenda: ${agenda}`:'') +
      (retira?` — Retira en local`:'') +
      (facturaEmpresa && rut?` — RUT: ${rut}`:'');

    const body = new URLSearchParams({
      action:'pedido_crear',
      nombre, email,
      telefono,
      direccion: direccionExtendida
    });

    try{
      const r = await fetch(API, {method:'POST', body, credentials:'include'});
      const j = await r.json();
      if(!r.ok){ alert(j.error || 'No pudimos confirmar el pedido'); return; }

      // Vaciar carrito local para mantener coherencia con backend
      localStorage.removeItem('carrito');
      localStorage.setItem('total','0');

      msg.textContent = `¡Gracias! Pedido #${j.pedido_id} confirmado. Te contactamos para coordinar la entrega.`;
      msg.style.display='block';
      // Redirigimos al inicio luego de unos segundos
      setTimeout(()=> location.href='index.html', 2200);
    }catch(e){
      alert('Error de red');
    }
  };
</script>

</body>
</html>
